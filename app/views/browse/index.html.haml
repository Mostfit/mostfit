= js_include_tag 'Jit/jit-yc'
= js_include_tag :treemap, :hbarchart

= css_include_tag 'jit-base','treemap'
:javascript
  var date = new Date('#{@date.strftime("%Y-%m-%d")}')
  var date_string = date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate();
  function get_charts(q) {
    $.get('/graph_data/tm_collections?' + q,'', function(data){
      init_barchart($.parseJSON(data).pmts_barchart);
      init_treemap($.parseJSON(data).treemap);
      });
    }

  $(document).ready(function(){ get_charts('date=' + date_string)});

- debugger
- bnames = @branch_names.keys.sort
- keys = [:advance_principal_paid, :advance_interest_paid, :principal_paid, :principal_due, :interest_paid, :interest_due]
%script{:type => "text/javascript"}
  == names=['#{bnames.join("','")}']
  == values = ['#{@branch_names.values.join("','")}']
#stats
  - total = {}
  - @branch_data.each do |bid, bv|
    - keys.each do |k|
      - total[k] ||= 0
      - total[k] += bv.send(k)
  %table#menu{:style => "float:left; position: relative; left: 1px;"}
    %tr.selected
      %th
        %h1
          today
      %td.number
        %h1.green
          = total[:principal_paid] + total[:interest_paid]
        %p collected
      %td.number
        %h1
          = total[:principal_due] + total[:interest_due]
        %p due
      %td.number
        %h1.red
          1,745
        %p
          missed
    - debugger
    %tr
      %th
        %h1 meetings
        - pt = Center.paying_today(session.user) 
      %td.number
        %h1
          = pt.count
        %p 
          mtngs
          %br
          today
      %td.number
        %h1
          = pt.select{|c| c.meeting_time_hours.to_i <= DateTime.now.hour}.count
        %p
          mtngs
          %br
          by now
      %td.number
        %h1
          - if pt.empty?
            0
          - else
            = Payment.all(:received_on => @date, :center_id => pt.aggregate(:id)).aggregate(:center_id).count
        %p
          meetings
          %br
          done
    %tr
      %th
        %h1 ytd
      %td.number{:colspan => "4"}
        %h1 0
        %p PAR
        

      
  .detail
    #today
      %table.new-report{:style => "margin: auto; width: 90%"}
        %thead
          %tr
            %th.purple
            - ["adv", "prin", "int", "fees","default","total"].each do |k|
              %th
                = k
        %tr
          %th
            Paid
          - t = 0
          - paid_values = [:total_advance_paid_today, :principal_paid, :interest_paid, :fees_paid_today]
          - keys.map do |k| 
            %td.green
              - value = total[k] || 0
              - t += value
              = value.to_currency.split(".")[0]
          %th
            = t.to_currency.split(".")[0]
        %tr
          %th
            Due
          - t = 0
          - keys.map{|k| k.to_s.split("_")[0..-2].join("_")}.uniq.each do |k|
            %td.red
              - value = total["#{k}_due".to_sym] || 0
              - t += value
              = value.to_currency.split(".")[0]
          %th
            = t.to_currency.split(".")[0]
      %h1.green
        = link_to "See a more detailed report", url(:controller => :browse, :action => :centers_paying_today)
      #hbarchart{:style => "width: 92%;  height: 30px; margin-left: 3%"}
      #infovis{:style => "width: 90%; height: 400px; margin: auto"}
      
 
            
    #staff
      %h1 Staff Members
    
    %table
      %tr
        %th
          
        
    
