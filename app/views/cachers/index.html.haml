= css_include_tag :screen, :diags
= js_include_tag :jquery, 'jquery.tablesorter.min'
:javascript
  $.tablesorter.addParser({ 
  id: 'mostfit_currency', 
  is: function(s) { 
  return false; 
  }, 
  format: function(s) { 
  return parseFloat(s.replace(/ /g, ''))
  }, 
  type: 'numeric' 
  }); 
     
  $(document).ready(function(){
    $($('table')[0]).tablesorter({headers: { 
    0: { sorter: 'date' },
    3: { sorter: 'mostfit_currency' },
    4: { sorter: 'mostfit_currency' },
    5: { sorter: 'mostfit_currency' },
    6: { sorter: 'mostfit_currency' },
    7: { sorter: 'mostfit_currency' }
    }} )});

- keys = [:date, :branch_id, :center_id, :scheduled_outstanding_total, :actual_outstanding_total, :scheduled_outstanding_principal,:actual_outstanding_principal, :principal_due, :principal_paid, :interest_due, :interest_paid, :fees_due_today, :fees_paid_today, :total_fees_due, :total_fees_paid]
- query_params = request.send(:query_params)
%ul
  %li
    = link_to "Caches Home", resource(:cachers)
  %li
    = link_to "#{Cacher.stale.count} stale caches", resource(:cachers, :stale => true)
Filter Dates:
- if query_params[:date]
  = link_to 'remove date filter', resource(:cachers, query_params.dup.delete_if{|k,v| k == "date"} || {})
- else
  - @cachers.aggregate(:date).each do |d|
    = link_to d, resource(:cachers, query_params.merge(:date => d))
%br
Filter Branches
- if query_params[:branch_id]
  = link_to 'remove branch filter', resource(:cachers, query_params.dup.delete_if{|k,v| k == "branch_id"} || {})
- else
  - @cachers.aggregate(:branch_id).each do |d|
    = link_to Branch.get(d).name, resource(:cachers, query_params.merge(:branch_id => d))
%table.diags{:style => "width: 1400px;"}
  %thead
    %tr
      - keys.each do |at|
        %th
          = at.to_s.gsub("_","<br>")
  - if params  and params[:center_id] and params[:date]
    - total = {}
    - cen = Center.get(params[:center_id])
    - date = Date.parse(params[:date])
    - histories = LoanHistory.latest({:center_id => cen.id}, date)
    - histories.each do |h|
      %tr
        - keys.each do |at|
          - val = h.send(at)
          %td
            = val.is_a?(Numeric) ? val.to_currency(:mostfit_default) : val
            - total[at] ||= 0
            - total[at] += h.send(at) if h.send(at).is_a? Numeric
        %td{:style => "background: #aaee00"}
          = link_to h.composite_key, "/loans/#{h.composite_key.floor}"
    %tr.total
      - keys.each do |at|
        %td
          = total[at].to_currency(:mostfit_default)
  - @cachers.sort_by{|c| [c.branch_id,c.center_id]}.each do |c|
    %tr{:class => cycle('odd','even')}
      - keys.each do |at|
        - val = c.send(at)
        %td{:style => "text-align: right"}
          - if at == :date
            = link_to val, resource(:cachers, request.send(:query_params).merge(:date => val))
          - elsif at == :branch_id
            - br = Branch.get(val)
            = link_to((br ? br.name : "-"), resource(:cachers, request.send(:query_params).merge(:branch_id => br.id)))
          - elsif at == :center_id
            - cen = Center.get(val)
            = link_to((cen ? cen.name[0..10] : "-"), resource(:cachers, request.send(:query_params).merge(:center_id => cen, :date => c.date)))
          - else
            = val == 0 ? "-" : val.to_currency(:mostfit_default)

